<!DOCTYPE html>

<html>
<head>
  <title>bionode-ncbi</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="bionode-ncbi">bionode-ncbi</h1>
<blockquote>
<p>Node.js module for working with the NCBI API (aka e-utils) using Streams.</p>
<p>doi: <a href="http://dx.doi.org/10.5281/zenodo.10610">10.5281/zenodo.10610</a>
author: <a href="http://bmpvieira.com">Bruno Vieira</a>
email: <a href="&#109;&#97;&#x69;&#x6c;&#x74;&#111;&#58;&#109;&#x61;&#x69;&#x6c;&#x40;&#98;&#109;&#112;&#118;&#x69;&#101;&#105;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#109;">&#109;&#x61;&#x69;&#x6c;&#x40;&#98;&#109;&#112;&#118;&#x69;&#101;&#105;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#109;</a>
license: <a href="https://raw.githubusercontent.com/bionode/bionode-ncbi/master/LICENSE">MIT</a></p>
</blockquote>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="usage">Usage</h2>
<p>This module can be used in Node.js as described further below, or as a command line tool.
Examples:</p>
<pre><code>$ npm install -g bionode-ncbi

# bionode-ncbi [command] [arguments] --limit (-l) --throughput (-t)
$ bionode-ncbi search taxonomy solenopsis
$ bionode-ncbi search sra human --limit 500 # only return 500 items
$ bionode-ncbi search sra human --throughput 250 # fetch 250 items per API request
$ bionode-ncbi download assembly solenopsis invicta
$ bionode-ncbi urls sra solenopsis invicta
$ bionode-ncbi link assembly bioproject 244018
$ bionode-ncbi search gds solenopsis | dat import --json
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>)
<span class="hljs-keyword">var</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>)
<span class="hljs-keyword">var</span> through = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through2'</span>)
<span class="hljs-keyword">var</span> xml2js = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xml2js'</span>).parseString
<span class="hljs-keyword">var</span> nugget = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nugget'</span>)
<span class="hljs-keyword">var</span> tool = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tool-stream'</span>)
<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'bionode-ncbi'</span>)
<span class="hljs-keyword">var</span> concat = <span class="hljs-built_in">require</span>(<span class="hljs-string">'concat-stream'</span>)
<span class="hljs-keyword">var</span> pumpify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pumpify'</span>)
<span class="hljs-keyword">var</span> URL = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>)
<span class="hljs-keyword">var</span> cheerio = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cheerio'</span>)
<span class="hljs-keyword">var</span> fasta = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bionode-fasta'</span>)

<span class="hljs-keyword">var</span> ncbi = exports

<span class="hljs-keyword">var</span> PROXY = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-string">'http://cors.inb.io/'</span> : <span class="hljs-string">''</span>

<span class="hljs-keyword">var</span> APIROOT = PROXY + <span class="hljs-string">'http://eutils.ncbi.nlm.nih.gov/entrez/eutils/'</span>
<span class="hljs-keyword">var</span> DEFAULTS = <span class="hljs-string">'retmode=json&amp;version=2.0'</span>
<span class="hljs-keyword">var</span> RETURNMAX = <span class="hljs-number">50</span>
<span class="hljs-keyword">var</span> XMLPROPERTIES = {
  <span class="hljs-string">'sra'</span>: [<span class="hljs-string">'expxml'</span>, <span class="hljs-string">'runs'</span>],
  <span class="hljs-string">'biosample'</span>: [<span class="hljs-string">'sampledata'</span>],
  <span class="hljs-string">'assembly'</span>: [<span class="hljs-string">'meta'</span> ]
}
<span class="hljs-keyword">var</span> LASTSTREAM = {
  <span class="hljs-string">'sra'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> pumpify.obj(
      tool.ensureIsArray(<span class="hljs-string">'runs.Run'</span>),
      tool.filterObjectsArray(<span class="hljs-string">'total_bases'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'runs.Run'</span>)
    )
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="search">Search</h2>
<p>Takes a NCBI database string and a optional search term and returns a stream of objects found:</p>
<pre><code>ncbi.search('sra', 'solenopsis').on('data', console.log)
=&gt; { uid: '280116',
     expxml: {"Summary":{"Title":"Single Solenopsis invicta male","Platform":{"_":"ILLUMINA", [...],
     runs: {"Run":[{"acc":"SRR620577","total_spots":"23699662","total_bases":"4787331724", [...],
     extlinks: '    ',
     createdate: '2013/02/07',
     updatedate: '2012/11/28' }
=&gt; { uid: '280243',
     expxml: {"Summary":{"Title":"Illumina small-insert paired end","Platform":{"_":"ILLUMINA", [...],
     runs: {"Run":[{"acc":"SRR621118","total_spots":"343209818","total_bases":"34320981800", [...],
     extlinks: '    ',
     createdate: '2013/02/07,
     updatedate: '2012/11/28' }
=&gt; [...]
</code></pre><p>Arguments can be passed as an object instead:</p>
<pre><code>ncbi.search({ db: <span class="hljs-string">'sra'</span>, term: <span class="hljs-string">'solenopsis'</span> })
.on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log)
</code></pre><p>Advanced options can be passed using the previous syntax:</p>
<pre><code><span class="hljs-keyword">var</span> options = {
  db: <span class="hljs-string">'assembly'</span>, <span class="hljs-comment">// database to search</span>
  term: <span class="hljs-string">'human'</span>,  <span class="hljs-comment">// optional term for search</span>
  limit: <span class="hljs-number">500</span>,     <span class="hljs-comment">// optional limit of NCBI results</span>
  throughput: <span class="hljs-number">100</span> <span class="hljs-comment">// optional number of items per request</span>
}
</code></pre><p>The search term can also be passed with write:</p>
<pre><code><span class="hljs-keyword">var</span> search = ncbi.search(<span class="hljs-string">'sra'</span>).on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log)
search.write(<span class="hljs-string">'solenopsis'</span>)
</code></pre><p>Or piped, for example, from a file:</p>
<pre><code><span class="hljs-keyword">var</span> split = <span class="hljs-built_in">require</span>(<span class="hljs-string">'split'</span>)

fs.createReadStream(<span class="hljs-string">'searchTerms.txt'</span>)
.pipe(split())
.pipe(search)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.search = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db, term, cb</span>) </span>{
  <span class="hljs-keyword">var</span> opts = <span class="hljs-keyword">typeof</span> db === <span class="hljs-string">'string'</span> ? { db: db, term: term } : db
  cb = <span class="hljs-keyword">typeof</span> term === <span class="hljs-string">'function'</span> ? term : cb

  <span class="hljs-keyword">var</span> stream = pumpify.obj(
    createAPISearchUrl(opts.db, opts.term),
    requestStream(<span class="hljs-literal">true</span>),
    createAPIPaginateURL(opts),
    requestStream(<span class="hljs-literal">true</span>),
    createAPIDataUrl(),
    fetchByID(opts.db)
  )

  <span class="hljs-keyword">if</span> (opts.term) { stream.write(opts.term); stream.end() }
  <span class="hljs-keyword">if</span> (cb) { stream.pipe(concat(cb)) } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> stream }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAPISearchUrl</span> (<span class="hljs-params">db, term</span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> query = [
      APIROOT + <span class="hljs-string">'esearch.fcgi?'</span>,
      DEFAULTS,
      <span class="hljs-string">'db='</span> + db,
      <span class="hljs-string">'term='</span> + <span class="hljs-built_in">encodeURI</span>(obj.toString().replace(<span class="hljs-regexp">/['"]+/g</span>, <span class="hljs-string">''</span>)),
      <span class="hljs-string">'usehistory=y'</span>
    ].join(<span class="hljs-string">'&amp;'</span>)
    debug(<span class="hljs-string">'esearch request'</span>, query)
    <span class="hljs-keyword">this</span>.push(query)
    next()
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAPIPaginateURL</span> (<span class="hljs-params">opts</span>) </span>{
  <span class="hljs-keyword">var</span> throughput = opts.throughput || RETURNMAX
  <span class="hljs-keyword">if</span> (opts.limit &lt; throughput) { throughput = opts.limit }
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> esearchRes = obj.body.esearchresult
    <span class="hljs-keyword">if</span> (esearchRes === <span class="hljs-literal">undefined</span>
        || esearchRes.webenv === <span class="hljs-literal">undefined</span>
        || esearchRes.count === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">var</span> msg = <span class="hljs-string">'NCBI returned invalid results, this could be a temporary'</span> +
                <span class="hljs-string">' issue with NCBI servers.\nRequest URL: '</span> + obj.url
      <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg))
      <span class="hljs-keyword">return</span> next()
    }
    <span class="hljs-keyword">var</span> count = opts.limit || esearchRes.count
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">parseInt</span>(esearchRes.count, <span class="hljs-number">10</span>) === <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.push(obj.url)
      <span class="hljs-keyword">return</span> next()
    }
    <span class="hljs-keyword">var</span> urlQuery = URL.parse(obj.url, <span class="hljs-literal">true</span>).query
    <span class="hljs-keyword">var</span> numRequests = <span class="hljs-built_in">Math</span>.ceil(count / throughput)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; numRequests; i++) {
      <span class="hljs-keyword">var</span> retstart = i * throughput
      <span class="hljs-keyword">var</span> query = [
        APIROOT + <span class="hljs-string">'esearch.fcgi?'</span>,
        DEFAULTS,
        <span class="hljs-string">'db='</span> + urlQuery.db,
        <span class="hljs-string">'term='</span> + urlQuery.term,
        <span class="hljs-string">'query_key=1'</span>,
        <span class="hljs-string">'WebEnv='</span> + esearchRes.webenv,
        <span class="hljs-string">'retmax='</span> + throughput,
        <span class="hljs-string">'retstart='</span> + retstart
      ].join(<span class="hljs-string">'&amp;'</span>)
      debug(<span class="hljs-string">'paginate request'</span>, query)
      <span class="hljs-keyword">this</span>.push(query)
    }
    next()
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAPIDataUrl</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> idsChunkLen = <span class="hljs-number">50</span>
    <span class="hljs-keyword">var</span> idlist = obj.body.esearchresult.idlist
    <span class="hljs-keyword">if</span> (!idlist || idlist.length === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> next() }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; idlist.length; i += idsChunkLen) {
      <span class="hljs-keyword">var</span> idsChunk = idlist.slice(i, i + idsChunkLen)
      <span class="hljs-keyword">var</span> urlQuery = URL.parse(obj.url, <span class="hljs-literal">true</span>).query
      <span class="hljs-keyword">var</span> query = [
        APIROOT + <span class="hljs-string">'esummary.fcgi?'</span>,
        DEFAULTS,
        <span class="hljs-string">'db='</span> + urlQuery.db,
        <span class="hljs-string">'id='</span> + idsChunk.join(<span class="hljs-string">','</span>),
        <span class="hljs-string">'usehistory=y'</span>
      ].join(<span class="hljs-string">'&amp;'</span>)
      debug(<span class="hljs-string">'esummary request'</span>, query)
      <span class="hljs-keyword">this</span>.push(query)
    }
    next()
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchByID</span> (<span class="hljs-params">db</span>) </span>{
  <span class="hljs-keyword">var</span> xmlProperties = XMLPROPERTIES[db] || through.obj()
  <span class="hljs-keyword">var</span> lastStream = LASTSTREAM[db] || through.obj
  <span class="hljs-keyword">var</span> stream = pumpify.obj(
    requestStream(<span class="hljs-literal">true</span>),
    tool.extractProperty(<span class="hljs-string">'body.result'</span>),
    tool.deleteProperty(<span class="hljs-string">'uids'</span>),
    tool.arraySplit(),
    tool.XMLToJSProperties(xmlProperties),
    lastStream()
  )
  <span class="hljs-keyword">return</span> stream
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="link">Link</h2>
<p>Takes a string for source NCBI database and another for destination db and returns
a objects stream with unique IDs linked to the passed source db unique ID.</p>
<pre><code>ncbi.link(<span class="hljs-string">'taxonomy'</span>, <span class="hljs-string">'sra'</span>, <span class="hljs-number">443821</span>)
=&gt; { <span class="hljs-string">"srcDB"</span>:<span class="hljs-string">"taxonomy"</span>,
     <span class="hljs-string">"destDB"</span>:<span class="hljs-string">"sra"</span>,
     <span class="hljs-string">"srcUID"</span>:<span class="hljs-string">"443821"</span>,

     <span class="hljs-string">"destUID"</span>:<span class="hljs-string">"677548"</span> }
=&gt; { <span class="hljs-string">"srcDB"</span>:<span class="hljs-string">"taxonomy"</span>,
     <span class="hljs-string">"destDB"</span>:<span class="hljs-string">"sra"</span>,
     <span class="hljs-string">"srcUID"</span>:<span class="hljs-string">"443821"</span>,
     <span class="hljs-string">"destUID"</span>:<span class="hljs-string">"677547"</span> }
=&gt; [...]
</code></pre><p>Also works with write and pipe, like <strong>Search</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.link = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">srcDB, destDB, srcUID, cb</span>) </span>{
  <span class="hljs-keyword">var</span> stream = pumpify.obj(
    createAPILinkURL(srcDB, destDB),
    requestStream(<span class="hljs-literal">true</span>),
    createLinkObj()
  )

  <span class="hljs-keyword">if</span> (srcUID) { stream.write(srcUID); stream.end() }
  <span class="hljs-keyword">if</span> (cb) { stream.on(<span class="hljs-string">'data'</span>, cb) } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> stream }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAPILinkURL</span> (<span class="hljs-params">srcDB, destDB</span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">if</span> (srcDB === <span class="hljs-string">'tax'</span>) { srcDB = <span class="hljs-string">'taxonomy'</span> }
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> query = [
      APIROOT + <span class="hljs-string">'elink.fcgi?'</span>,
      <span class="hljs-string">'dbfrom='</span> + srcDB,
      <span class="hljs-string">'db='</span> + destDB,
      <span class="hljs-string">'id='</span> + obj.toString()
    ].join(<span class="hljs-string">'&amp;'</span>)
    <span class="hljs-keyword">this</span>.push(query)
    next()
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createLinkObj</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> query = URL.parse(obj.url, <span class="hljs-literal">true</span>).query
    <span class="hljs-keyword">var</span> result = {
      srcDB: query.dbfrom,
      destDB: query.db,
      srcUID: query.id
    }
    xml2js(obj.body, gotParsed)
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotParsed</span> (<span class="hljs-params">err, data</span>) </span>{
      <span class="hljs-keyword">if</span> (err) { self.emit(<span class="hljs-string">'error'</span>, err); <span class="hljs-keyword">return</span> next() }
      <span class="hljs-keyword">if</span> (!data.eLinkResult.LinkSet[<span class="hljs-number">0</span>].LinkSetDb) { <span class="hljs-keyword">return</span> next() }
      data.eLinkResult.LinkSet[<span class="hljs-number">0</span>].LinkSetDb.forEach(getMatch)
      self.push(result)
      next()
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMatch</span> (<span class="hljs-params">link</span>) </span>{
      <span class="hljs-keyword">var</span> linkName = query.dbfrom + <span class="hljs-string">'_'</span> + query.db
      <span class="hljs-keyword">if</span> (link.LinkName[<span class="hljs-number">0</span>] !== linkName) { <span class="hljs-keyword">return</span> }
      <span class="hljs-keyword">var</span> destUIDs = []
      link.Link.forEach(getLink)
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLink</span> (<span class="hljs-params">link</span>) </span>{ destUIDs.push(link.Id[<span class="hljs-number">0</span>]) }
      result.destUIDs = destUIDs
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="property-link-plink-">Property link (Plink)</h2>
<p>Similar to Link but taked the srcID from a property of the Streamed object
and attached the result to a property with the name of the destination DB.</p>
<pre><code>ncbi.search(<span class="hljs-string">'genome'</span>, <span class="hljs-string">'arthropoda'</span>)
.pipe(ncbi.expand(<span class="hljs-string">'tax'</span>))
.pipe(ncbi.plink(<span class="hljs-string">'tax'</span>, <span class="hljs-string">'sra'</span>)
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.plink = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">property, destDB</span>) </span>{
  <span class="hljs-keyword">var</span> srcDB = property.split(<span class="hljs-string">'.'</span>).pop()
  <span class="hljs-keyword">var</span> destProperty = destDB + <span class="hljs-string">'id'</span>
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> id = tool.getValue(obj, property + <span class="hljs-string">'id'</span>)
    <span class="hljs-keyword">if</span> (!id) {
      self.push(obj)
      <span class="hljs-keyword">return</span> next()
    }
    <span class="hljs-keyword">if</span> (!obj[destProperty]) { obj[destProperty] = [] }
    ncbi.link(srcDB, destDB, id, gotData)
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotData</span> (<span class="hljs-params">data</span>) </span>{
      <span class="hljs-keyword">if</span> (data.destUIDs) { obj[destProperty] = data.destUIDs }
      self.push(obj)
      next()
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="download">Download</h2>
<p>Takes a NCBI database string and a optional search term and downloads the datasets/sequence files.
<strong> Currently only supports sra and assembly databases. </strong>
Also accepts the keyword gff for annotations.
Returns a stream that emits download progress and ends with download path
The name of the folder where the file is saved corresponds to the UID from NCBI.</p>
<pre><code>ncbi.download('assembly', 'solenopsis invicta')
.on('data', console.log)
.on('end', function(path) {
  console.log('File saved at ' + path)
}
=&gt; Downloading 244018/unplaced.scaf.fa.gz 0.94 % of 106 MB at 0.48 MB/s
=&gt; Downloading 244018/unplaced.scaf.fa.gz 100.00 % of 106 MB at 0.49 MB/s"
=&gt; File saved at 244018/unplaced.scaf.fa.gz
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.download = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db, term, cb</span>) </span>{
  <span class="hljs-keyword">var</span> stream = pumpify.obj(
    ncbi.urls(db),
    download(db)
  )
  <span class="hljs-keyword">if</span> (term) { stream.write(term); stream.end() }
  <span class="hljs-keyword">if</span> (cb) { stream.pipe(concat(cb)) } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> stream }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span> (<span class="hljs-params">db</span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> folder = obj.uid + <span class="hljs-string">'/'</span>

    <span class="hljs-keyword">var</span> extractFiles = {
      <span class="hljs-string">'sra'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.url },
      <span class="hljs-string">'gff'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.genomic.gff },
      <span class="hljs-string">'gbff'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.genomic.gbff },
      <span class="hljs-string">'gpff'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.protein.gpff },
      <span class="hljs-string">'assembly'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.genomic.fna },
      <span class="hljs-string">'fasta'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.genomic.fna },
      <span class="hljs-string">'fna'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.genomic.fna },
      <span class="hljs-string">'faa'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.protein.faa },
      <span class="hljs-string">'repeats'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.rm.out },
      <span class="hljs-string">'md5'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> obj.md5checksums.txt }
    }
    <span class="hljs-keyword">var</span> url = extractFiles[db]()

    <span class="hljs-keyword">var</span> path = folder + url.replace(<span class="hljs-regexp">/.*\//</span>, <span class="hljs-string">''</span>)

    <span class="hljs-keyword">var</span> log = {
      uid: obj.uid,
      url: url,
      path: path
    }

    mkdirp(obj.uid, {mode: <span class="hljs-string">'0755'</span>}, gotDir)
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDir</span> (<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err) { self.emit(<span class="hljs-string">'error'</span>, err) }
      debug(<span class="hljs-string">'downloading'</span>, url)
      <span class="hljs-keyword">var</span> options = { dir: folder, resume: <span class="hljs-literal">true</span> }
      <span class="hljs-keyword">var</span> dld = nugget(PROXY + url, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> self.destroy(err)
        fs.stat(path, gotStat)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotStat</span> (<span class="hljs-params">err, stat</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> self.destroy(err)
          log.status = <span class="hljs-string">'completed'</span>
          log.speed = <span class="hljs-string">'NA'</span>
          log.size = <span class="hljs-built_in">Math</span>.round(stat.size / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>) + <span class="hljs-string">' MB'</span>
          self.push(log)
          next()
        }
      })
      dld.on(<span class="hljs-string">'progress'</span>, logging)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logging</span> (<span class="hljs-params">data</span>) </span>{
      log.status = <span class="hljs-string">'downloading'</span>
      log.total = data.transferred
      log.progress = data.percentage
      log.speed = data.speed
      self.push(log)
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="urls">URLs</h2>
<p>Takes a NCBI database string and a optional search term and returns as stream of dataset/sequence files URLs.
<strong> Currently only supports sra and assembly databases. </strong>
Also accepts the keyword gff for annotations.
The value of the uid property corresponds to the UID from NCBI.</p>
<pre><code>ncbi.urls(<span class="hljs-string">'assembly'</span>, <span class="hljs-string">'solenopsis invicta'</span>)
.on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log)
=&gt; {<span class="hljs-string">"url"</span>:<span class="hljs-string">"http://ftp.ncbi.nlm.nih.gov/genbank/genomes/Eukaryotes/invertebrates/Solenopsis_invicta/Si_gnG/Primary_Assembly/unplaced_scaffolds/FASTA/unplaced.scaf.fa.gz"</span>,
    <span class="hljs-string">"uid"</span>:<span class="hljs-string">"244018/"</span>}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.urls = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db, term, cb</span>) </span>{
  <span class="hljs-keyword">var</span> opts = <span class="hljs-keyword">typeof</span> db === <span class="hljs-string">'string'</span> ? { db: db } : db
  cb = <span class="hljs-keyword">typeof</span> term === <span class="hljs-string">'function'</span> ? term : cb
  <span class="hljs-keyword">var</span> extractFiles = [<span class="hljs-string">'gff'</span>, <span class="hljs-string">'gpff'</span>, <span class="hljs-string">'fasta'</span>, <span class="hljs-string">'fna'</span>, <span class="hljs-string">'faa'</span>, <span class="hljs-string">'repeats'</span>]
  <span class="hljs-keyword">if</span> (extractFiles.indexOf(db) !== -<span class="hljs-number">1</span>) { opts.db = <span class="hljs-string">'assembly'</span> }

  <span class="hljs-keyword">var</span> stream = pumpify.obj(
    ncbi.search(opts),
    createFTPURL(opts.db)
  )
  <span class="hljs-keyword">if</span> (term) { stream.write(term); stream.end() }
  <span class="hljs-keyword">if</span> (cb) { stream.pipe(concat(cb)) } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> stream }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFTPURL</span> (<span class="hljs-params">db</span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> parseURL = {
      sra: sraURL,
      assembly: assemblyURL
    }

    parseURL[db]()

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sraURL</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> runs = obj.runs.Run
      <span class="hljs-keyword">async</span>.eachSeries(runs, printSRAURL, next)
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printSRAURL</span> (<span class="hljs-params">run, cb</span>) </span>{
        <span class="hljs-keyword">var</span> acc = run.acc
        <span class="hljs-keyword">var</span> runURL = [
          <span class="hljs-string">'http://ftp.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByRun/sra/'</span>,
          acc.slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) + <span class="hljs-string">'/'</span>,
          acc.slice(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>) + <span class="hljs-string">'/'</span>,
          acc + <span class="hljs-string">'/'</span>,
          acc + <span class="hljs-string">'.sra'</span>
        ].join(<span class="hljs-string">''</span>)
        self.push({url: runURL, uid: obj.uid})
        cb()
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">assemblyURL</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (obj.meta.FtpSites) {
        <span class="hljs-keyword">var</span> ftpPath = obj.meta.FtpSites.FtpPath
        <span class="hljs-keyword">var</span> ftpArray = <span class="hljs-built_in">Array</span>.isArray(ftpPath) ? ftpPath : [ ftpPath ]
        <span class="hljs-keyword">var</span> httpRoot = ftpArray[<span class="hljs-number">0</span>]._.replace(<span class="hljs-string">'ftp://'</span>, <span class="hljs-string">'http://'</span>) <span class="hljs-comment">// NCBI seems to return GenBank and RefSeq accessions for the same thing. We only need one.</span>
        request({ uri: PROXY + httpRoot, withCredentials: <span class="hljs-literal">false</span> }, gotFTPDir)
      } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> next() }
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotFTPDir</span> (<span class="hljs-params">err, res, body</span>) </span>{
        <span class="hljs-keyword">if</span> (err) { self.emit(<span class="hljs-string">'error'</span>, err) }
        <span class="hljs-keyword">if</span> (!res || res.statusCode !== <span class="hljs-number">200</span>) { self.emit(<span class="hljs-string">'err'</span>, res) }
        <span class="hljs-keyword">if</span> (!body) { <span class="hljs-keyword">return</span> next() }
        <span class="hljs-keyword">var</span> $ = cheerio.load(body)

        <span class="hljs-keyword">var</span> urls = { uid: obj.uid }

        $(<span class="hljs-string">'a'</span>).map(attachToResult)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attachToResult</span> (<span class="hljs-params">i, a</span>) </span>{
          <span class="hljs-keyword">var</span> href = a.attribs.href
          <span class="hljs-keyword">var</span> base = path.basename(href)
          <span class="hljs-keyword">var</span> fileNameProperties = base.replace(<span class="hljs-regexp">/.*\//</span>, <span class="hljs-string">''</span>).split(<span class="hljs-string">'_'</span>)
          <span class="hljs-keyword">var</span> fileNameExtensions = fileNameProperties[fileNameProperties.length - <span class="hljs-number">1</span>].split(<span class="hljs-string">'.'</span>)
          <span class="hljs-keyword">var</span> fileType = fileNameExtensions[<span class="hljs-number">0</span>]
          <span class="hljs-keyword">var</span> fileFormat = fileNameExtensions[<span class="hljs-number">1</span>] || <span class="hljs-string">'dir'</span>
          <span class="hljs-keyword">if</span> (!urls[fileType]) { urls[fileType] = {} }
          urls[fileType][fileFormat] = httpRoot + <span class="hljs-string">'/'</span> + href
        }
        self.push(urls)
        next()
      }
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestStream</span> (<span class="hljs-params">returnURL</span>) </span>{
  <span class="hljs-keyword">var</span> timeout = <span class="hljs-number">15000</span>
  <span class="hljs-keyword">var</span> interval = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    get()
    self.tries = <span class="hljs-number">1</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (self.tries &gt; <span class="hljs-number">20</span>) { <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'try '</span> + self.tries + obj) }
      request({ uri: obj, json: <span class="hljs-literal">true</span>, timeout: timeout, withCredentials: <span class="hljs-literal">false</span> }, gotData)
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotData</span> (<span class="hljs-params">err, res, body</span>) </span>{
        <span class="hljs-keyword">if</span> (err
        || !res
        || res.statusCode !== <span class="hljs-number">200</span>
        || !body
        || (body.esearchresult &amp;&amp; body.esearchresult.ERROR)
        || (body.esummaryresult &amp;&amp; body.esummaryresult[<span class="hljs-number">0</span>] === <span class="hljs-string">'Unable to obtain query #1'</span>)
        || body.error
        ) {
          self.tries++
          <span class="hljs-keyword">return</span> setTimeout(get, interval)
        }
        debug(<span class="hljs-string">'request response'</span>, res.statusCode)
        debug(<span class="hljs-string">'request results'</span>, body)
        <span class="hljs-keyword">var</span> result = returnURL ? {url: obj, body: body} : body
        self.push(result)
        setTimeout(next, interval)
      }
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="expand">Expand</h2>
<p>Takes a property (e.g., biosample) and optional destination property
(e.g., sample) and looks for a field named property+id (biosampleid)
in the Streamed object. Then it will do a ncbi.search for that id and save
the result under Streamed object.property.</p>
<pre><code>ncbi.search(<span class="hljs-string">'genome'</span>, <span class="hljs-string">'arthropoda'</span>).pipe(ncbi.expand(<span class="hljs-string">'assembly'</span>))
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.expand = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">property, destProperty</span>) </span>{
  destProperty = destProperty || property
  <span class="hljs-keyword">var</span> db = property.split(<span class="hljs-string">'.'</span>).pop()
  <span class="hljs-keyword">if</span> (db === <span class="hljs-string">'tax'</span>) { db = <span class="hljs-string">'taxonomy'</span> }

  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> ids = tool.getValue(obj, property + <span class="hljs-string">'id'</span>)
    <span class="hljs-keyword">if</span> (!ids) {
      self.push(obj)
      <span class="hljs-keyword">return</span> next()
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Taxonomy doesnâ€™t work just with ID number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (db === <span class="hljs-string">'taxonomy'</span>) { ids = ids + <span class="hljs-string">'[uid]'</span> }

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(ids)) {
      <span class="hljs-keyword">async</span>.map(ids, search, gotData)
    } <span class="hljs-keyword">else</span> {
      search(ids, gotData)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">search</span> (<span class="hljs-params">term, cb</span>) </span>{
      <span class="hljs-keyword">var</span> stream = ncbi.search(db)
      stream.write(term)
      stream.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{ cb(<span class="hljs-literal">null</span>, data) })
      stream.on(<span class="hljs-string">'end'</span>, next)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotData</span> (<span class="hljs-params">err, data</span>) </span>{
      <span class="hljs-keyword">if</span> (err) { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err) }
      obj[destProperty] = data
      self.push(obj)
      next()
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="fetch">Fetch</h2>
<p>Allows retrieval of records from NCBI databases. Takes the database name and a search term,
and returns the records from the database that match the search term. There are optional
advanced parameters that allow you to define how many records to retrieve and extra options
for genes. These parameters should be passed as an object.</p>
<p>It can return a subset of a genetic sequence of a requested species</p>
<pre><code> ncbi.fetch('sra', 'solenopsis_invicta')
 =&gt; {"EXPERIMENT_PACKAGE_SET":
       {"EXPERIMENT_PACKAGE":
         [{"EXPERIMENT":
           [{"$":{"xmlns":"","alias":"Me","accession":"SRX757228,
           ...
</code></pre><p>With advanced optional parameters:</p>
<pre><code> <span class="hljs-keyword">var</span> opts = {
   db: <span class="hljs-string">'nucest'</span>,
   term: <span class="hljs-string">'guillardia_theta'</span>,
   strand: <span class="hljs-number">1</span>,
   complexity: <span class="hljs-number">4</span>,
   seq_start: <span class="hljs-number">1</span>,
   seq_stop: <span class="hljs-number">50</span>
 }

 ncbi.fetch(opts)
 =&gt; { id: <span class="hljs-string">'gi|557436392|gb|HE992975.1|HE992975:1-50 HE992975 Guillardia theta CCMP 327 Guillardia theta cDNA clone sg-p_014_h06, mRNA sequence'</span>,
      seq: <span class="hljs-string">'GAAGGCGATTCCAATGGTGCGAGCGAGGCAGCGAACAGACGCAGCGGGGA'</span> }
    { id: <span class="hljs-string">'gi|557436391|gb|HE992974.1|HE992974:1-50 HE992974 Guillardia theta CCMP 327 Guillardia theta cDNA clone sg-p_014_h05, mRNA sequence'</span>,
      seq: <span class="hljs-string">'GTCGCGGTTGGCATGGCTGAGGAGAATCCGATCCCTCGGCTAGACGCCTG'</span> }
 =&gt; [...]
</code></pre><p>For some databases there are multiple return types. A default one will be chosen
automatically, however it is possible to specify this via the rettype option.</p>
<p>The NCBI website provides a list of databasese supported by efetch here:
<a href="http://www.ncbi.nlm.nih.gov/books/NBK25497/table/chapter2.T._entrez_unique_identifiers_ui/?report=objectonly">http://www.ncbi.nlm.nih.gov/books/NBK25497/table/chapter2.T._entrez_unique_identifiers_ui/?report=objectonly</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
ncbi.fetch = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">db, term, cb</span>) </span>{
  <span class="hljs-keyword">var</span> opts = <span class="hljs-keyword">typeof</span> db === <span class="hljs-string">'string'</span> ? { db: db, term: term } : db
  cb = <span class="hljs-keyword">typeof</span> term === <span class="hljs-string">'function'</span> ? term : cb

  <span class="hljs-keyword">var</span> rettypes = {
    bioproject: <span class="hljs-string">'xml'</span>,
    biosample: <span class="hljs-string">'full'</span>,
    biosystems: <span class="hljs-string">'xml'</span>,
    gds: <span class="hljs-string">'summary'</span>,
    gene: <span class="hljs-string">''</span>,
    homologene: <span class="hljs-string">'fasta'</span>,
    mesh: <span class="hljs-string">'full'</span>,
    nlmcatalog: <span class="hljs-string">'xml'</span>,
    nuccore: <span class="hljs-string">'fasta'</span>,
    nucest: <span class="hljs-string">'fasta'</span>,
    nucgss: <span class="hljs-string">'fasta'</span>,
    protein: <span class="hljs-string">'fasta'</span>,
    popset: <span class="hljs-string">'fasta'</span>,
    pmc: <span class="hljs-string">''</span>,
    pubmed: <span class="hljs-string">''</span>,
    snp: <span class="hljs-string">'fasta'</span>,
    sra: <span class="hljs-string">'full'</span>,
    taxonomy: <span class="hljs-string">''</span>
  }

  <span class="hljs-keyword">var</span> retmodes = {
    fasta: <span class="hljs-string">'fasta'</span>,
    <span class="hljs-string">'native'</span>: <span class="hljs-string">'xml'</span>,
    full: <span class="hljs-string">'xml'</span>,
    xml: <span class="hljs-string">'xml'</span>,
    <span class="hljs-string">''</span>: <span class="hljs-string">'xml'</span>,
    <span class="hljs-string">'asn.1'</span>: <span class="hljs-string">'asn.1'</span>
  }

  opts.rettype = opts.rettype || rettypes[opts.db]
  opts.retmode = retmodes[opts.rettype] || <span class="hljs-string">'text'</span>

  <span class="hljs-keyword">var</span> stream = pumpify.obj(
      createAPISearchUrl(opts.db, opts.term),
      requestStream(<span class="hljs-literal">true</span>),
      createAPIPaginateURL(opts),
      requestStream(<span class="hljs-literal">true</span>),
      createAPIFetchUrl(opts, stringifyExtras(opts)),
      parseResult(opts.retmode)
  )

  <span class="hljs-keyword">if</span> (opts.term) { stream.write(opts.term); stream.end() }
  <span class="hljs-keyword">if</span> (cb) { stream.pipe(concat(cb)) } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> stream }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stringifyExtras</span> (<span class="hljs-params">opts</span>) </span>{
  <span class="hljs-keyword">var</span> extraOptsLine = <span class="hljs-string">''</span>

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> opts) {
    <span class="hljs-keyword">if</span> ((k !== <span class="hljs-string">'term'</span>) &amp;&amp; (k !== <span class="hljs-string">'db'</span>)) {
      extraOptsLine += k + <span class="hljs-string">'='</span> + opts[k] + <span class="hljs-string">'&amp;'</span>
    }
  }

  <span class="hljs-keyword">return</span> extraOptsLine.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createAPIFetchUrl</span> (<span class="hljs-params">opts, extraOpts</span>) </span>{
  <span class="hljs-keyword">var</span> stream = through.obj(transform)
  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">obj, enc, next</span>) </span>{
    <span class="hljs-keyword">var</span> idsChunkLen = <span class="hljs-number">50</span>
    <span class="hljs-keyword">var</span> idlist = obj.body.esearchresult.idlist
    <span class="hljs-keyword">if</span> (!idlist || idlist.length === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> next() }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; idlist.length; i += idsChunkLen) {
      <span class="hljs-keyword">var</span> idsChunk = idlist.slice(i, i + idsChunkLen)
      <span class="hljs-keyword">var</span> urlQuery = URL.parse(obj.url, <span class="hljs-literal">true</span>).query
      <span class="hljs-keyword">var</span> query = [
        APIROOT + <span class="hljs-string">'efetch.fcgi?'</span>,
        <span class="hljs-string">'version=2.0'</span>,
        <span class="hljs-string">'db='</span> + urlQuery.db,
        <span class="hljs-string">'id='</span> + idsChunk.join(<span class="hljs-string">','</span>),
        extraOpts,
        <span class="hljs-string">'userhistory=y'</span>
      ].join(<span class="hljs-string">'&amp;'</span>)
      debug(<span class="hljs-string">'efetch request'</span>, query)
      <span class="hljs-keyword">this</span>.push(query)
    }
    next()
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseResult</span> (<span class="hljs-params">resFmt</span>) </span>{
  <span class="hljs-keyword">var</span> lastStream = (resFmt === <span class="hljs-string">'fasta'</span>) ? fasta.obj : through.obj

  <span class="hljs-keyword">var</span> stream = pumpify.obj(
      requestStream(<span class="hljs-string">'true'</span>),
      preProcess(),
      lastStream()
  )

  <span class="hljs-keyword">return</span> stream

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">preProcess</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> stream = through.obj(transform)
    <span class="hljs-keyword">return</span> stream

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transform</span> (<span class="hljs-params">chunk, enc, cb</span>) </span>{
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
      <span class="hljs-keyword">if</span> (resFmt === <span class="hljs-string">'xml'</span>) {
        xml2js(chunk.body, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, data</span>) </span>{
          <span class="hljs-keyword">if</span> (err) { self.emit(<span class="hljs-string">'error'</span>, err); <span class="hljs-keyword">return</span> cb() }
          self.push(data)
          cb()
        })
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resFmt === <span class="hljs-string">'fasta'</span>) {
        self.push(chunk.body)
        cb()
      } <span class="hljs-keyword">else</span> {
        self.push({result: chunk.body})
        cb()
      }
    }
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
